<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">

<head>
   <meta charset="UTF-8">
   <title>Estimate</title>
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
	 
	
   
</head>

<body>
<div layout:fragment="header" class="page-heading"><h2>견적</h2></div>
	<div layout:fragment="content" class="page-content">
				
		<div class="mb-1">
				
			<div style="height:50px; margin-bottom:10px">
				<label for="planName" style="width:100px">견적코드</label>
				<input type="text" class="form-control" style="width:200px; display:inline" placeholder="견적코드" id="InEstmtCodeSearch">&nbsp;
			</div>
			
			<div style="height:50px; margin-bottom:10px">
				<label for="planName" style="width:100px">거래처</label>
				<input type="text" class="form-control"style="width:200px; display:inline" placeholder="거래처명" id="InClientCodeSearch">&nbsp;
				
				
				
            </div>
            
            <div>
				<label for="planDate" style="width:100px">견적일자</label>
				<input type="date" class="form-control" style="width:200px; display:inline" id="InEstmtDateSearch">&nbsp;
				<button type="button" class="btn btn-sm btn-primary" id="estmtDateSearch">검색</button>&nbsp;
				<button type="button" class="btn btn-sm btn-secondary" id="estmtDateReset">초기화</button>
			
           </div>
           <div>
               <button type="button" class="btn btn-sm btn-primary" style="float:right;  margin:5px; margin-right: 30px">승인</button>   
               <button id="showModal" type="button" class="btn btn-sm btn-primary" style= "float:right;  margin:5px;"
                  data-bs-toggle="modal" data-bs-target="#staticBackdrop">견적서 등록</button>
			</div>

			
          </div>        
      
	<div id ="grid"></div>
	
	<div><br></div>
	
	<div id ="grid2"></div>
	
	<!--  모달창  -->
      <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
		  <div class="modal-dialog modal-lg">
		    <div class="modal-content">
		    
		      <div class="modal-header">
		        <h5 class="modal-title" id="staticBackdropLabel">견적서 등록</h5>
		        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		      </div>
		      
		      <div class="modal-body">
		      	<div class="container-fluid">
		      		
				        	<label for="row1" style="width:80px; height: 30px; text-align:center;">견적번호</label>
				        		<input stype="text" class="form-control"style="width:150px; display:inline" readonly>
				        	
				    		<label for="row1" style="width:80px; height: 30px; text-align:center;  ">납기일자</label>
								<input type="date" class="form-control" style="width: 150px; display:inline; text-align:center;">
								
				   			<div><br></div>
				   			
				        	<label for="row2" style="width:80px; height: 30px; text-align:center;" >거래처코드 </label>
				         		<select id="select8" name="no"  class="btn" style="width:150px; border:1px solid #dce7f1;; background-color:white">
				         			<option value="선택">----선 택----</option>
				         			<th:block th:each="v : ${clientName}">
				         				<option th:value="${v.clientCode}" th:text="${v.clientCode}"></option>
				         			</th:block>		
				         		</select>
				   		
				   			
				   			<label for="row2" style="width:80px; height: 30px; text-align:center;" >거래처명</label>
				         		<select id="select5" name="no"  class="form-control" style="width: 150px; display:inline; text-align:center;">
				         			<option value="선택">----선 택----</option>
				         			<th:block th:each="v : ${clientName}">
				         				<option th:value="${v.clientName}" th:text="${v.clientName}"></option>
				         			</th:block>		
				         		</select>
				         		
							<div><br></div>
				   		
				   			<label for="row3" style="width:80px; height: 30px; text-align:center;" >제품코드</label>
				         		<select id="select6" name="no" onchange="handleOnChange6(this)" class="form-control" style="width: 150px; display:inline; text-align:center;">
				         			<option value="선택">----선 택----</option>
				         			<th:block th:each="v : ${proCode}">
				         				<option th:value="${v.proCode}" th:text="${v.proCode}"></option>
				         			</th:block>		
				         		</select>

				   			
				   			<label for="row3" style="width:80px; height: 30px; text-align:center;" >제품명</label>
				         		<select id="select7" name="no" onchange="handleOnChange7(this)" class="form-control" style="width: 150px; display:inline; text-align:center;">
				         			<option value="선택">----선 택----</option>
				         			<th:block th:each="v: ${proCode}">
				         				<option th:value="${v.proName}" th:text="${v.proName}"></option>
				         			</th:block>  			
				         		</select>
				         		
				         	<label for="row3" style="width:80px; height: 30px; text-align:center;" >수량</label>	
				         		<input stype="text" class="form-control"style="width:150px; display:inline" >
				         	<div><br></div>
				         	<div>
					         	<button onclick="modalResetBtn()" type="button"  class="btn-sm btn-secondary" style="float:right;" >초기화</button></td>
					         	<button onclick="plusPro()" type="button" class="btn-sm btn-primary" style="float:right; margin-right:5px" >제품추가</button></td>
				         	
				         	</div>
			       </div>
			    
		      </div>
		        
		        
					 <div id ="grid3"></div>
				
		        
		      <div class="modal-footer">
		        <button onclick="insertEstmt" type="button" class="btn btn-primary">등록</button>
		        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
		      </div>
		      
		    </div>
		  </div>
		</div>
	    
	    <!--  모달창 끝 -->
    

	


	<script>
	
		const Grid = tui.Grid;
		
		
		const grid = new Grid({
            el: document.getElementById('grid'), // Container element
            scrollX: false,
            scrollY: false,
            rowHeaders: ['checkbox'],
            columns: [
                {
                	header: '견적코드',
                	name: 'estmtCode',
                	filter : 'text',
                },
                {
                	header: '거래처',
                	name: 'clientCode',
                	filter : 'text',
                	
                },
                {
                	header: '견적일자',
                    name: 'estmtDate',
                    filter : 'date'
                 },
                 {
                 	header: '납기일자',
                    name: 'deDate',
                    filter : 'select'
                 },
                 {
                  	header: '총합계액',
                     name: 'fallSum',
                     
                     
                  },
                  {
                	  header:'승인',
                	  name: 'estmtSt',
                	  filter : 'select'
                  }
                  
	
                //체크박스
                /* {
                    header: '승인',
                    name: 'estmtSt1',
                    formatter: 'listItemText',
                    editor: {
                                type: 'checkbox',
                                options: {
                                    listItems: [
                                        {
                                            text: 'O',
                                            value: '1'
                                        },
                                        {
                                            text: 'X',
                                            value: '2'
                                        }
                                    ]
                                }
                            }
                }, */

            ]
           
	
		});
		
		
		const grid2 = new Grid({
            el: document.getElementById('grid2'), // Container element
            scrollX: false,
            scrollY: false,
            columns: [
                
                {
                	header: '제품코드',
                	name: 'PRO_CODE'
                },
                {
                	header: '제품명',
                    name: 'PRO_NAME'
                 },
                 {
                 	header: '수량',
                    name: 'SELL_NUM'
                 },
                 {
                  	header: '단가',
                     name: 'fsell_price'
                  },
                 
                 {
                  	header: '합계액',
                     name: 'FSUM_PRICE'
                  },
            ]
          
		});
		
		
		const grid3 = new Grid({
            el: document.getElementById('grid3'), // Container element
            scrollX: false,
            scrollY: false,
            columns: [
                {
                	header: '제품코드',
                	name: 'proCode'
                },
                {
                	header: '제품명',
                	name: 'proName'
                },
                 {
                 	header: '수량',
                    name: 'sellNum'
                 },
                 {
                  	header: '단가',
                     name: 'sellPrice'
                  },
                 
                 {
                  	header: '합계액',
                     name: 'sumPrice'
                  }
                  
            ]
		});
		
		
		Grid.applyTheme('striped'); // Call API of static method
		
		
		//모달창 선택값 리셋
		function modalResetBtn(e){
			console.log("버튼")
			$("#select6").val() == '선택'
			$("#select7").val() == '선택'
				
					
		}
		
		
		// 모달창 둘중에 하나만 선택 되도록 58거래처     67제품
		
		function handleOnChange5(e){
			if($("#select5").val() != '선택'){
				$("#select8").attr('disabled', true)
			}
		} 

		
		function handleOnChange8(e){
			if($("#select8").val() != '선택'){
				$("#select5").attr('disabled', true)
			}
		
		}
		
		
		
		function handleOnChange6(e){
			if($("#select6").val() != '선택'){
				$("#select7").attr('disabled', true)
			}
			
		}
		
		
		 function handleOnChange7(e){
			 if($("#select7").val() != '선택'){
					$("#select6").attr('disabled', true)
			 }
		}
		
			 
		
		//수량 * 단가 = 합계액
		function add(){
			if(document.getElementById("num").value && document.getElementById("price").value){
				
			}
				  document.getElementById('allsum').value =
					  parseInt(document.getElementById('num').value) * parseInt(document.getElementById('price').value);
		}
		
		
		
		
	//모달창
   	staticBackdrop.addEventListener('shown.bs.modal', () => {
   	      grid3.refreshLayout(); //모달창 새로고침
   	 })
		
   	 
	
	//실행시 전체조회
	document.addEventListener("DOMContentLoaded",estmtList)
	   	
		function estmtList(){
			console.log('12');
			$.ajax({
				url:'/listEstimate',
				success : function(result) {
					console.log(result)
					grid.resetData(result);
				},
				error : function(error){
					console.log(11);
				}
			})
			
		}
   	 
	
	

	
	 //tr clickevent
	 grid.on('click', (event)=>{
		 console.log('clicked');
		 console.log(event);
		 console.log(event.nativeEvent.target.textContent);		//d
		 var a  = event.nativeEvent.target.textContent;
				
		 $.ajax({
					method:'GET',
					url:'/listEstimated?estmtCode='+a,
					success : function(result) {
						console.log(result)
						grid2.resetData(result);
					},
					error : function(error){
						console.log(11);
					}
				})

	 })
	
	
	 // select 8 5    6 7
	 //$.("select6")
	 
	 /*  //input
	if($("#select6").val() != '선택'){
			$("#select7").attr('disabled', true)
		}
	 
	 if($("#select7").val() != '선택'){
			$("#select6").attr('disabled', true)
		} */
	 
	 
	 
	 function plusPro(){
		 
		 if($("#select6").val() == $("#result6").val( ) || ($("#result6" != null) ||  $("#select6").val() != null )){
			 
		 	if($("#select7").val() == $("#result7").val() || ($("#result6" != null) ||  $("#select6").val() != null )){
				alert("제품추가성공");
				//ajax로 값 보내고 grid에 출력하기 
				$.ajax({
					method :'POST',
					url:'/insertEstmtD',
					succes : function(result){
						grid3.reset(result);
					},
					error : function(error){
						console.log(error);
					}
					
				})
				
		 	}else{
			 	alert("제품 올바르게 선택해주세요1");
		 }
		}else{
		 	alert("제품 올바르게 선택해주세요2");
	 	}
		 
		 
		 
	 }
	 
	 
		function insertEstmt(){
		 
		 if($("#select8").val() == $("#result8").val() || $("#result8" != null) ||  $("#select8").val() != null ){
			 
		 	if($("#select5").val() == $("#result5").val()  || $("#result5" != null) || $("#select5").val() != null ){
				alert("등록성공");
				
				//ajax로 값 보내고 grid에 출력하기 
				 $("#form").submit();
		 	}else{
			 	alert("거래처 올바르게 선택해주세요1");
		 }
		}else{
		 	alert("거래처 올바르게 선택해주세요2");
	 	}
		 
		 
		 
	 }
	 
		
	
		
	//조회버튼 / 리셋버튼

	
	estmtDateSearch.addEventListener('click', () => {
		grid.filter('estmtCode' , [{code:'contain', value:$('#InEstmtCodeSearch').val()}])
		grid.filter('clientCode' , [{code:'contain', value:$('#InClientCodeSearch').val()}])
		if($('#InEstmtDateSearch').val() != '' ){
			grid.filter('estmtDate' , [{code:'beforeEq', value:$('#InEstmtDateSearch').val()}])
			
		}
	});

		
	estmtDateReset.addEventListener('click', () => {
		document.getElementById('InEstmtCodeSearch').value = '';
		grid.unfilter('estmtCode');
		document.getElementById('InClientCodeSearch').value = '';
		grid.unfilter('clientCode');
		document.getElementById('InEstmtDateSearch').value = '';
		grid.unfilter('estmtDate');
	})	
	
	
		
	//
	 
	</script>
	</div>
</body>

</html>